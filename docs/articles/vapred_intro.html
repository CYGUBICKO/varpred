<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="varpred">
<title>Outcome plots • varpred</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Outcome plots">
<meta property="og:description" content="varpred">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">varpred</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/vapred_intro.html">Outcome plots</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="vapred_intro_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Outcome plots</h1>
                        <h4 data-toc-skip class="author">Bicko Cygu, Ben Bolker, Jonathan Dushoff</h4>
            
      
      
      <div class="d-none name"><code>vapred_intro.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="motivation">Motivation<a class="anchor" aria-label="anchor" href="#motivation"></a>
</h2>
<p>The development of this package is motivated by the water, sanitation, and hygiene (WaSH) data in which we were interested in investigating the contribution of demographic and socio-economic factors to improved WaSH indicators among the slum dwellers in Nairobi, Kenya. We noticed that the predictions we generated using the existing packages consistently over- or under- estimated the observed proportions; and did not align well with the observed data points. In other words, what we call <em>bias</em>. There are several (challenges) reasons for this, including:</p>
<ul>
<li>the choice of the <em>reference point</em>
</li>
<li>uncertainty estimation – the choice of <em>anchor</em> for computing confidence intervals</li>
<li>biases induced by non-linear averaging due to non-linear transformation in generalized linear models</li>
</ul>
</div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>An outcome plot (often called effect or prediction plot), plots <em>focal</em> predictor on the x-axis and <em>central estimate</em> (predicted values) on the y-axis. The resulting plot provide a useful way to summarize the results from a regression model; and depend on how we deal with the above challenges.</p>
<div class="section level3">
<h3 id="mean-based-approach">Mean-based approach<a class="anchor" aria-label="anchor" href="#mean-based-approach"></a>
</h3>
<p>In a model with non-focal predictors such as multivariate models, reference points (values chosen for non-focal predictors) can be chosen as the average of the non-focal <em>linear predictor variables</em> (columns of the model matrix corresponding to non-focal predictors) – we call this approach <em>mean-based</em> reference point and is currently not implemented in commonly used <strong>R</strong> software .</p>
<p>To illustrate this, we use <code><a href="https://rdrr.io/r/datasets/mtcars.html" class="external-link">datasets::mtcars</a></code> dataset to fit two models: 1) one without interaction, and 2) one with interaction between predictors.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">datasets</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/datasets/mtcars.html" class="external-link">mtcars</a></span>

<span class="co">## No interaction model</span>
<span class="va">mod1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">wt</span> <span class="op">+</span> <span class="va">disp</span> <span class="op">+</span> <span class="va">hp</span>, <span class="va">df</span><span class="op">)</span>

<span class="co">## Model with interaction</span>
<span class="va">mod2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">wt</span> <span class="op">+</span> <span class="va">disp</span><span class="op">*</span><span class="va">hp</span>, <span class="va">df</span><span class="op">)</span></code></pre></div>
<p>If we consider <code>wt</code> as the focal predictor, then the remaining (<code>disp</code> and <code>hp</code>) are non-focal predictors. We use <code>varpred</code>, <code>emmeans</code> and <code>Effects</code> for comparison.</p>
<p><strong>vapred package</strong>:</p>
<ul>
<li>
<code>bias.adjust="none"</code>: to generate mean-based</li>
<li>All the three packages have different ways of generating values of focal predictor. For comparison, we use quantile and generate same focal values. Unless you want to compare with same values, this is not necessary.</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">varpred</span><span class="op">)</span>
<span class="fu"><a href="../reference/varpredtheme.html">varpredtheme</a></span><span class="op">(</span><span class="op">)</span>

<span class="co">## generate values for focal predictor</span>
<span class="va">steps</span> <span class="op">&lt;-</span> <span class="fl">500</span>
<span class="va">quant</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out<span class="op">=</span><span class="va">steps</span><span class="op">)</span>
<span class="va">wt_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">wt</span>, <span class="va">quant</span>, names<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> |&gt; <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span>

<span class="co">## No interaction</span>
<span class="va">vpred1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/varpred.html">varpred</a></span><span class="op">(</span>mod<span class="op">=</span><span class="va">mod1</span>
    , focal_predictors<span class="op">=</span><span class="st">"wt"</span>
    , at<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>wt<span class="op">=</span><span class="va">wt_values</span><span class="op">)</span>
    , bias.adjust<span class="op">=</span><span class="st">"none"</span>
    , modelname<span class="op">=</span><span class="st">"varpred: no interaction"</span>
<span class="op">)</span>

<span class="co">## With interaction</span>
<span class="va">vpred2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/varpred.html">varpred</a></span><span class="op">(</span>mod<span class="op">=</span><span class="va">mod2</span>
    , focal_predictors<span class="op">=</span><span class="st">"wt"</span>
    , at<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>wt<span class="op">=</span><span class="va">wt_values</span><span class="op">)</span>
    , bias.adjust<span class="op">=</span><span class="st">"none"</span>
    , modelname<span class="op">=</span><span class="st">"varpred: with interaction"</span>
<span class="op">)</span>
<span class="va">names_use</span> <span class="op">&lt;-</span> <span class="va">vpred2</span> |&gt; <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span> |&gt; <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><strong>emmeans package</strong>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rvlenth/emmeans" class="external-link">emmeans</a></span><span class="op">)</span>
<span class="va">em1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/emmeans/man/emmeans.html" class="external-link">emmeans</a></span><span class="op">(</span><span class="va">mod1</span>
    , specs<span class="op">=</span><span class="op">~</span><span class="va">wt</span>
    , at<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>wt<span class="op">=</span><span class="va">wt_values</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">em1</span> <span class="op">&lt;-</span> <span class="va">em1</span> |&gt; <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">em1</span><span class="op">$</span><span class="va">model</span> <span class="op">&lt;-</span> <span class="st">"emmeans: no interaction"</span>
<span class="va">em1</span><span class="op">$</span><span class="va">df</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">em1</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">names_use</span>

<span class="va">em2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/emmeans/man/emmeans.html" class="external-link">emmeans</a></span><span class="op">(</span><span class="va">mod2</span>
    , specs<span class="op">=</span><span class="op">~</span><span class="va">wt</span>
    , at<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>wt<span class="op">=</span><span class="va">wt_values</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">em2</span> <span class="op">&lt;-</span> <span class="va">em2</span> |&gt; <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">em2</span><span class="op">$</span><span class="va">model</span> <span class="op">&lt;-</span> <span class="st">"emmeans: with interaction"</span>
<span class="va">em2</span><span class="op">$</span><span class="va">df</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">em2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">names_use</span></code></pre></div>
<p><strong>Effects package</strong>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.r-project.org" class="external-link">effects</a></span><span class="op">)</span>
<span class="co">#&gt; Loading required package: carData</span>
<span class="co">#&gt; lattice theme set by effectsTheme()</span>
<span class="co">#&gt; See ?effectsTheme for details.</span>
<span class="va">ef1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/effects/man/effect.html" class="external-link">Effect</a></span><span class="op">(</span><span class="st">"wt"</span>
    , <span class="va">mod1</span>
    , xlevels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>wt<span class="op">=</span><span class="va">wt_values</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">ef1</span> <span class="op">&lt;-</span> <span class="va">ef1</span> |&gt; <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">ef1</span><span class="op">$</span><span class="va">model</span> <span class="op">&lt;-</span> <span class="st">"effects: no interaction"</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">ef1</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">names_use</span>

<span class="va">ef2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/effects/man/effect.html" class="external-link">Effect</a></span><span class="op">(</span><span class="st">"wt"</span>
    , <span class="va">mod2</span>
    , xlevels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>wt<span class="op">=</span><span class="va">wt_values</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">ef2</span> <span class="op">&lt;-</span> <span class="va">ef2</span> |&gt; <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">ef2</span><span class="op">$</span><span class="va">model</span> <span class="op">&lt;-</span> <span class="st">"effects: with interaction"</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">ef2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">names_use</span></code></pre></div>
<p>We can use <code><a href="../reference/combinevarpred.html">varpred::combinevarpred</a></code> to combine and compared the estimates:</p>
<ul>
<li>
<code>attrvpred</code>: converts <code>emmeans</code> and <code>effects</code> objects to <code>varpred</code>
</li>
<li>
<code>varpred::getmeans</code>: calculates marginal means of the estimates to compare with the data mean (mean of observed data)</li>
</ul>
<p>The plot below compares the central estimates (trend lines), together with their mean (horizontal lines) with the data mean (mean of <code>mpg</code>) and the observed data (grey points).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>
<span class="co">## Combine emmeans, effects and varpred objects</span>
<span class="co">## and convert all to varpred objects for ploting</span>
<span class="va">attrvpred</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">obj</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">obj</span>, <span class="st">"varpred"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">temp_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>
        <span class="va">obj</span><span class="op">$</span><span class="va">method</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">".*\\: "</span>, <span class="st">""</span>, <span class="va">obj</span><span class="op">$</span><span class="va">model</span><span class="op">)</span>
        <span class="va">obj</span><span class="op">$</span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"\\:.*"</span>, <span class="st">""</span>, <span class="va">obj</span><span class="op">$</span><span class="va">model</span><span class="op">)</span>
        <span class="va">temp_obj</span><span class="op">$</span><span class="va">preds</span> <span class="op">&lt;-</span> <span class="va">obj</span>
        <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">temp_obj</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"varpred"</span>
        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">temp_obj</span><span class="op">)</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
        <span class="va">obj</span><span class="op">$</span><span class="va">preds</span><span class="op">$</span><span class="va">method</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">".*\\: "</span>, <span class="st">""</span>, <span class="va">obj</span><span class="op">$</span><span class="va">preds</span><span class="op">$</span><span class="va">model</span><span class="op">)</span>
        <span class="va">obj</span><span class="op">$</span><span class="va">preds</span><span class="op">$</span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"\\:.*"</span>, <span class="st">""</span>, <span class="va">obj</span><span class="op">$</span><span class="va">preds</span><span class="op">$</span><span class="va">model</span><span class="op">)</span>
        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">obj</span><span class="op">)</span>
    <span class="op">}</span>
<span class="op">}</span>
<span class="va">all_preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">vpred1</span>, <span class="va">vpred2</span>, <span class="va">em1</span>, <span class="va">em2</span>, <span class="va">ef1</span>, <span class="va">ef2</span><span class="op">)</span>, <span class="va">attrvpred</span><span class="op">)</span>

<span class="co">## Compute marginal means: mean of the estimates</span>
<span class="va">all_means</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">all_preds</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
    <span class="va">model</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">preds</span><span class="op">$</span><span class="va">model</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
    <span class="va">method</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">preds</span><span class="op">$</span><span class="va">method</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
    <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu">getmeans</span><span class="op">(</span><span class="va">x</span>, focal<span class="op">=</span><span class="st">"wt"</span>, modelname<span class="op">=</span><span class="va">model</span><span class="op">)</span>
    <span class="va">m</span><span class="op">$</span><span class="va">method</span> <span class="op">&lt;-</span> <span class="va">method</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="va">all_means</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="va">all_means</span><span class="op">)</span>

<span class="co">## Data mean</span>
<span class="va">df_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>mpg<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">mpg</span><span class="op">)</span>
    , model<span class="op">=</span><span class="st">"data mean"</span>
<span class="op">)</span>

<span class="co">## Plot all the estimates</span>
<span class="va">p1</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="../reference/combinevarpred.html">combinevarpred</a></span><span class="op">(</span><span class="va">all_preds</span>, plotit<span class="op">=</span><span class="cn">TRUE</span>, ci<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
    <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">wt</span>, y<span class="op">=</span><span class="va">mpg</span><span class="op">)</span>, col<span class="op">=</span><span class="st">"grey"</span><span class="op">)</span>
    <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df_mean</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>yintercept<span class="op">=</span><span class="va">mpg</span>, color<span class="op">=</span><span class="va">model</span>, linetype<span class="op">=</span><span class="va">model</span><span class="op">)</span><span class="op">)</span> 
    <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">all_means</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>yintercept<span class="op">=</span><span class="va">fit</span>, colour<span class="op">=</span><span class="va">model</span>, linetype<span class="op">=</span><span class="va">model</span><span class="op">)</span><span class="op">)</span>
    <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">method</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">p1</span><span class="op">)</span></code></pre></div>
<p><img src="vapred_intro_files/figure-html/simple-mean-based-combine-1.png" width="700"></p>
<p>In the absence of interaction (left Figure), the three packages produce identical estimates and their respective averages closely match the data mean. However, in the presence of interactions, the estimates from <code>emmeans</code> and <code>effects</code> are identical but differ from <code>varpred</code>’s, which is very close to the data mean.</p>
<p>The packages <code>emmeans</code> and <code>effects</code> use the average of the input variables (mean of <code>disp</code> and <code>hp</code>) as the reference point as opposed to model-center approach <code>varpred</code> (average of the linear predictor variables). In the simple model (left Figure above) input variables are the same as the linear predictor variables, so all the three methods produce identical results. In the interaction model (right Figure above), there is an additional linear predictor variable (<code>disp*hp</code>). <code>emmeans</code> and <code>effects</code> first average the input variables to compute <span class="math inline">\(\mathrm{\bar{disp}}\star\mathrm{\bar{hp}}\)</span> while <code>varpred</code> first calculates the corresponding vector of linear predictor values and then averages.</p>
</div>
<div class="section level3">
<h3 id="prediction-and-effect-plots">Prediction and effect plots<a class="anchor" aria-label="anchor" href="#prediction-and-effect-plots"></a>
</h3>
<p>The major distinction between the two lies on how we describe the uncertainty around the central estimates (trend lines in the previous Figures). The prediction plot captures all the sources of uncertainty, including that of intercept, non-focal predictors and random effects. On the other hand, effect plot takes into account the uncertainty associated with the focal predictor only. This way, we expect an effect plot to have narrower confidence intervals (CIs) then a prediction plot.</p>
<p>It is not easy to generate effect plots in <code>emmeans</code> and <code>effects</code>. A possible way to achieve this in <code>emmeans</code> and <code>effects</code> is to use a zeroed-out (see <code><a href="../reference/zero_vcov.html">varpred::zero_vcov</a></code>) covariance matrix, but this only works when the input variables are centered prior to model fitting, in case of numerical variables, and more complicated when the input variables are categorical.</p>
<p>In <code>varpred</code>, to generate effect plot, we set <code>isolate=TRUE</code> (default), otherwise (<code>isolate=FALSE</code>) prediction plot. We consider <code>vpred1</code> generated above, which is an effect plot, and now generate a prediction for the same model (<code>mod1</code>).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## prediction-styled plot: set isolate=FALSE</span>
<span class="va">vpred1_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/varpred.html">varpred</a></span><span class="op">(</span>mod<span class="op">=</span><span class="va">mod1</span>
    , focal_predictors<span class="op">=</span><span class="st">"wt"</span>
    , isolate<span class="op">=</span><span class="cn">FALSE</span>
    , at<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>wt<span class="op">=</span><span class="va">wt_values</span><span class="op">)</span>
    , bias.adjust<span class="op">=</span><span class="st">"none"</span>
    , modelname<span class="op">=</span><span class="st">"prediction"</span>
<span class="op">)</span>

<span class="co">## Rename vpred1</span>
<span class="va">vpred1</span><span class="op">$</span><span class="va">preds</span><span class="op">$</span><span class="va">model</span> <span class="op">&lt;-</span> <span class="st">"effects"</span>

<span class="va">p2</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">vpred1</span>, <span class="va">vpred1_pred</span><span class="op">)</span>
    |&gt; <span class="fu"><a href="../reference/combinevarpred.html">combinevarpred</a></span><span class="op">(</span>plotit<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
    <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df_mean</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>yintercept<span class="op">=</span><span class="va">mpg</span>, color<span class="op">=</span><span class="va">model</span>, linetype<span class="op">=</span><span class="va">model</span><span class="op">)</span><span class="op">)</span> 
    <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">wt_values</span><span class="op">)</span>, lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">p2</span><span class="op">)</span></code></pre></div>
<p><img src="vapred_intro_files/figure-html/simple-pred-effect-1.png" width="700"></p>
<p>The Figure above shows a prediction (-styled) and an effect (-styled) plot. The horizontal line is the mean of the data (mean of <code>mpg</code>) while the vertical one is the mean of the focal predictor (<code>wt</code>) – we call this <em>center point</em>. The wider curves correspond to the conventional prediction curves (prediction-styled plot), while the narrower curves crossing at the center point. For a simple linear model, effect-styled curves cross at the center point. In other words, effects-styled plots provide a way to generate effects indicating uncertainty due only to <em>changes</em> in the focal predictor.</p>
</div>
<div class="section level3">
<h3 id="anchor">Anchor<a class="anchor" aria-label="anchor" href="#anchor"></a>
</h3>
<p>To generate an effect-styled plot, we need a value of the focal predictor to compute CIs. We call this an <em>anchor</em>. The anchor choice does not affect the central estimate, nor prediction-style plot. The default value is the center point of the linear predictor variables corresponding to the focal predictor. For example, in the previous Figure, mean of <code>wt</code> is used as the default choice.</p>
<p>This is particularly important when we want to show an effect at a particular value of the focal predictor other than its mean (center point). For example, at <span class="math inline">\(0\)</span>, minimum of the focal predictor, etc. To implement this in <strong>varpred</strong>, set the anchor value using <code>isolate.value</code> and <code>isolate</code> must be <code>TRUE</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Min of wt</span>
<span class="va">anchor0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/varpred.html">varpred</a></span><span class="op">(</span><span class="va">mod1</span>
    , <span class="st">"wt"</span>
    , isolate<span class="op">=</span><span class="cn">TRUE</span>
    , isolate.value<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">wt</span><span class="op">)</span> <span class="co"># min anchor</span>
    , modelname<span class="op">=</span><span class="st">"min"</span>
<span class="op">)</span>

<span class="co">## mean-anchored (default)</span>
<span class="va">anchor0.5</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/varpred.html">varpred</a></span><span class="op">(</span><span class="va">mod1</span>
    , <span class="st">"wt"</span>
    , isolate<span class="op">=</span><span class="cn">TRUE</span>
    , modelname<span class="op">=</span><span class="st">"mean"</span>
<span class="op">)</span>

<span class="va">p3</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">anchor0</span>, <span class="va">anchor0.5</span><span class="op">)</span>
    |&gt; <span class="fu"><a href="../reference/combinevarpred.html">combinevarpred</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># No plot</span>
    |&gt; <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span>
    <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>colour<span class="op">=</span><span class="st">"Anchor"</span>, linetype<span class="op">=</span><span class="st">"Anchor"</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">p3</span><span class="op">)</span></code></pre></div>
<p><img src="vapred_intro_files/figure-html/simple-anchor-1.png" width="700"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Bicko Cygu, Ben Bolker, Jonathan Dushoff.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
